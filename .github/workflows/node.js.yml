# This workflow will do a clean install of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: TSTL Build && Artifact Upload

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build TSTL Artifact
    runs-on: ubuntu-latest

    env:
      NPM_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
      
    steps:  
    - uses: actions/checkout@v2
    - name: Use Node.js [16.x]
      uses: actions/setup-node@v2
      with:
        node-version: 16.x
        cache: 'npm'
    - run: npm install && npm run-script git-publish
    - run: cp package.json ./dist/ && cp package-lock.json ./dist/ && cp README.md ./dist/ && cp LICENSE ./dist/ && cp .npmrc ./dist/
    - uses: actions/upload-artifact@v2.2.4
      with:
        path: ./dist/
        name: build

  test:
    name: Build TSTL Tests and Run them
    runs-on: ubuntu-latest
      
    steps:
    - name: Install LuaRocks
      uses: leafo/gh-actions-luarocks@v4.0.0
    - uses: actions/checkout@v2
    - name: Use Node.js [16.x]
      uses: actions/setup-node@v2
      with:
        node-version: 16.x
        cache: 'npm'
    - run: npm install && npm run-script build-testing
    - uses: actions/upload-artifact@v2.2.4
      with:
        path: ./testing/
        name: testing
    - run: cd testing && luarocks install busted
    - run: busted
        
  deploy: 
    name: Deploy Artifact
    runs-on: ubuntu-latest
    if: "contains(github.event.head_commit.message, '@deploy-to-npm')"
    needs: build
    env:
      NPM_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
    
    steps:
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2.0.10
      - name: Move to Artifact folder
        run: cd artifact
      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: 'npm'
      - name: npm bump
        uses: bcomnes/npm-bump@v2.0.2
        with:
          git_email: monke@blah.com
          git_username: github.actor
          newversion: patch
          push_version_commit: true
          npm_token: ${{secrets.NPM_ACCESS_TOKEN}}
